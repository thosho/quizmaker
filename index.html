<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Quiz Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f9f9f9; 
      line-height: 1.5; 
      position: relative; /* For absolute positioning */
    }
    body.dark {
      background: #121212;
      color: #ffffff;
    }
    body.dark .quiz {
      background: #1e1e1e;
    }
    body.dark input, body.dark textarea, body.dark select {
      background: #333;
      color: #fff;
      border: 1px solid #555;
    }
    body.dark button {
      background: #388E3C; /* Darker green */
    }
    body.dark button:hover {
      background: #2E7D32;
    }
    body.dark button.reset {
      background: #D32F2F;
    }
    body.dark button.reset:hover {
      background: #B71C1C;
    }
    body.dark .score {
      color: #A5D6A7;
      background: #1B5E20;
    }
    body.dark .loading {
      color: #81C784;
    }
    body.dark .error {
      color: #EF5350;
    }
    body.dark #infoModal {
      background: #1e1e1e;
      color: #fff;
    }
    body.dark #infoModal a {
      color: #81C784;
    }
    h2 { 
      text-align: center; 
      margin-bottom: 20px; 
      position: relative; 
      font-family: 'Orbitron', sans-serif; /* Digital-style font */
      font-size: 2em;
    }
    h2 .score {
      position: absolute;
      top: 0;
      right: 0;
      font-weight: bold;
      font-size: 18px;
      color: #4CAF50;
      background: #e8f5e9;
      padding: 5px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: none; /* Hidden initially */
      font-family: Arial, sans-serif; /* Keep score font normal */
    }
    textarea { 
      width: 100%; 
      height: 120px; 
      padding: 10px; 
      margin-bottom: 10px; 
      box-sizing: border-box; 
    }
    input[type="text"], input[type="file"], input[type="password"] { 
      width: 100%; 
      padding: 10px; 
      margin-bottom: 10px; 
      box-sizing: border-box; 
    }
    .select-container {
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      margin-bottom: 10px;
      align-items: flex-end; /* Align bottoms for info button */
    }
    select { 
      padding: 10px; 
      box-sizing: border-box; 
      width: auto; /* Auto width based on content */
      min-width: 100px; /* Minimum width to prevent too small */
    }
    button { 
      padding: 10px 15px; 
      border: none; 
      background: #4CAF50; 
      color: white; 
      cursor: pointer; 
      border-radius: 6px; 
      margin-top: 10px; 
      width: 100%; 
      box-sizing: border-box; 
    }
    button:hover { background: #45a049; }
    button.reset { background: #f44336; } /* Red for reset button */
    button.reset:hover { background: #d32f2f; }
    .quiz { 
      margin-top: 20px; 
      padding: 15px; 
      background: white; 
      border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
    .question { margin-bottom: 15px; }
    .question button { width: auto; } /* Check buttons auto width */
    .api-section { margin-bottom: 20px; }
    .api-section label {
      display: block; /* Stack vertically */
      margin-bottom: 5px;
    }
    .error { color: red; text-align: center; }
    .loading { color: blue; text-align: center; font-style: italic; }
    .hidden { display: none; }
    #infoModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      max-width: 400px;
      display: none;
    }
    #infoModal h3 { margin-top: 0; }
    #infoModal ol { margin: 10px 0; padding-left: 20px; }
    #infoModal a { color: #4CAF50; text-decoration: underline; }
    #infoModal button { width: auto; background: #4CAF50; margin-top: 10px; }
    #darkModeToggle {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      height: 40px; /* Align with selects */
    }
    footer {
      text-align: center;
      font-family: 'Orbitron', sans-serif;
      font-size: 12px;
      margin-top: 20px;
      color: #666; /* Subtle color */
    }
    body.dark footer {
      color: #bbb;
    }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body { margin: 10px; }
      h2 { font-size: 1.5em; }
      button { font-size: 1em; }
      .quiz { padding: 10px; }
      h2 .score { font-size: 14px; padding: 5px; top: -10px; right: 0; }
      .select-container { 
        flex-direction: column; 
        gap: 5px; 
        align-items: flex-start; /* Left-align in mobile */
      }
      select { width: 100%; }
      button.info { height: auto; }
      #infoModal { max-width: 90%; padding: 15px; }
      #darkModeToggle { font-size: 18px; }
      .question button { width: 100%; margin-top: 10px; } /* Stack check buttons vertically on mobile */
    }
  </style>
  <!-- Include pdf.js for PDF support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.338/pdf.min.js"></script>
  <!-- Include mammoth.js for DOCX support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>
<body>

  <h2>Quiz Maker <span id="scoreContainer" class="score"></span></h2>
  <div id="inputSection">
    <p>Create Your Own Quiz with Your Own Data & For Better Questions use "AI"</p>

    <textarea id="lessonInput" placeholder="Paste your lesson text or upload a file (TXT, PDF, DOCX):"></textarea>
    
    <input type="file" id="fileInput" accept=".txt,.pdf,.docx">

    <div class="api-section">
      <p>Choose AI source:</p>
      <label><input type="radio" name="aiSource" value="our" checked> Quiz Maker AI (Limited)</label>
      <label><input type="radio" name="aiSource" value="your"> Your own Gemini AI Key <button class="info" onclick="showInfo()" style="margin-left: 5px; width: auto; padding: 2px 6px; font-size: 12px;">?</button></label>
      <div id="yourKeySection" style="display: none; margin-bottom: 5px;">
        <p>Enter your Google Gemini API Key:</p>
        <input type="password" id="apiKeyInput" placeholder="Your Gemini API Key">
      </div>
      <label><input type="radio" name="aiSource" value="none"> Local (not advanced Qs)</label>
    </div>

    <div class="select-container">
      <div>
        <p>No of Q's :</p>
        <select id="numQuestions">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="25">25</option>
          <option value="50">50</option>
        </select>
      </div>
      <div>
        <p>Level :</p>
        <select id="difficulty">
          <option value="easy">Easy</option>
          <option value="medium">Medium</option>
          <option value="hard">Hard</option>
        </select>
      </div>
      <div>
        <p>Type :</p>
        <select id="quizType">
          <option value="multiple-choice">Multiple Choice</option>
          <option value="true-false">True/False</option>
        </select>
      </div>
      <div>
        <button id="darkModeToggle" onclick="toggleDarkMode()">🌙</button>
      </div>
    </div>
  </div>

  <button id="generateButton" onclick="generateQuiz()">Generate Quiz</button>
  <button class="reset" onclick="resetApp()">Reset</button>

  <div id="quizContainer" class="quiz"></div>
  <div id="errorContainer" class="error"></div>

  <!-- Info Modal -->
  <div id="infoModal">
    <h3>How to Create Your Own Gemini API Key</h3>
    <ol>
      <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</li>
      <li>Sign in with your Google account (or create one if needed).</li>
      <li>Click "Get API key" or create a new project.</li>
      <li>Copy the generated API key.</li>
      <li>Paste it into the "Your AI" input field in this app.</li>
    </ol>
    <p>Note: Free tier has usage limits; check Google's terms.</p>
    <button onclick="hideInfo()">Close</button>
  </div>

  <footer>Designed by THOSHO</footer>

  <script>
    const OUR_API_KEYS = [
      'AIzaSyAWzYm6D6z1XUWe8rSJbMuTqJqI_8kO-5U', // Replace with real key 1
      'YOUR_KEY_2_HERE', // Key 2
      'YOUR_KEY_3_HERE', // Key 3
      'YOUR_KEY_4_HERE', // Key 4
      'YOUR_KEY_5_HERE'  // Key 5
    ];

    let totalQuestions = 0;
    let correctAnswers = 0;
    let questions = []; // To store generated questions

    // Dark mode toggle
    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      const toggleBtn = document.getElementById('darkModeToggle');
      toggleBtn.textContent = document.body.classList.contains('dark') ? '☀️' : '🌙';
      localStorage.setItem('darkMode', document.body.classList.contains('dark') ? 'enabled' : 'disabled');
    }

    // Load dark mode preference
    if (localStorage.getItem('darkMode') === 'enabled') {
      toggleDarkMode();
    }

    // Toggle API key input visibility
    document.querySelectorAll('input[name="aiSource"]').forEach(radio => {
      radio.addEventListener('change', () => {
        document.getElementById('yourKeySection').style.display = radio.value === 'your' ? 'block' : 'none';
      });
    });

    // Show/Hide Info Modal
    function showInfo() {
      document.getElementById('infoModal').style.display = 'block';
    }
    function hideInfo() {
      document.getElementById('infoModal').style.display = 'none';
    }

    // Handle file upload and extract text
    document.getElementById("fileInput").addEventListener("change", async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const lessonInput = document.getElementById("lessonInput");
      const errorContainer = document.getElementById("errorContainer");

      if (file.name.endsWith(".txt")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          lessonInput.value = e.target.result;
        };
        reader.readAsText(file);
      } else if (file.name.endsWith(".docx")) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const arrayBuffer = e.target.result;
          const result = await mammoth.extractRawText({ arrayBuffer });
          lessonInput.value = result.value;
        };
        reader.readAsArrayBuffer(file);
      } else if (file.name.endsWith(".pdf")) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const typedarray = new Uint8Array(e.target.result);
          const loadingTask = pdfjsLib.getDocument(typedarray);
          const pdf = await loadingTask.promise;
          let text = '';
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str.trim()).filter(str => str).join(' ') + '\n\n';
          }
          lessonInput.value = text.trim(); // Clean up extra spaces
        };
        reader.readAsArrayBuffer(file);
      } else {
        errorContainer.innerHTML = "Unsupported file type. Please upload TXT, DOCX, or PDF.";
      }
    });

    async function generateQuiz() {
      const lesson = document.getElementById("lessonInput").value.trim();
      const aiSource = document.querySelector('input[name="aiSource"]:checked').value;
      const userApiKey = aiSource === 'your' ? document.getElementById("apiKeyInput").value.trim() : null;
      const numQuestions = document.getElementById("numQuestions").value;
      const difficulty = document.getElementById("difficulty").value;
      const quizType = document.getElementById("quizType").value;
      const quizContainer = document.getElementById("quizContainer");
      const scoreContainer = document.getElementById("scoreContainer");
      const errorContainer = document.getElementById("errorContainer");
      quizContainer.innerHTML = "";
      scoreContainer.innerHTML = "";
      scoreContainer.style.display = 'none'; // Hide score initially
      errorContainer.innerHTML = "";
      errorContainer.classList.remove('error');
      errorContainer.classList.add('loading');
      errorContainer.innerHTML = "Wait a second till we generate Your Quiz...";
      totalQuestions = 0;
      correctAnswers = 0;
      questions = [];

      if (!lesson) {
        errorContainer.classList.remove('loading');
        errorContainer.classList.add('error');
        errorContainer.innerHTML = "Please paste text or upload a file first.";
        return;
      }

      // Hide input section and generate button after successful input
      document.getElementById("inputSection").classList.add("hidden");
      document.getElementById("generateButton").style.display = 'none';

      let generated = false;

      if (aiSource !== 'none') {
        // Try AI generation
        const keysToUse = aiSource === 'our' ? OUR_API_KEYS : [userApiKey];
        for (let i = 0; i < keysToUse.length; i++) {
          try {
            const generatedQuestions = await generateAIQuestions(lesson, keysToUse[i], numQuestions, difficulty, quizType);
            questions = generatedQuestions;
            generated = true;
            break; // Success, stop trying other keys
          } catch (error) {
            if (i === keysToUse.length - 1) {
              errorContainer.innerHTML = "All API attempts failed: " + error.message + ". Falling back to local generation.";
            }
          }
        }
      } else {
        // No AI selected, use local generation directly
        generated = true;
      }

      // Fallback to local if AI failed or No AI selected
      if (!generated || aiSource === 'none') {
        questions = generateSimpleQuestions(lesson, numQuestions, difficulty, quizType);
      }

      errorContainer.innerHTML = ""; // Clear loading message
      errorContainer.classList.remove('loading');

      if (questions.length === 0) {
        errorContainer.classList.add('error');
        errorContainer.innerHTML = "Could not generate questions from the provided text.";
        document.getElementById("inputSection").classList.remove("hidden");
        document.getElementById("generateButton").style.display = 'block'; // Show generate on error
        return;
      }

      questions.forEach((q, index) => {
        totalQuestions++;
        let div = document.createElement("div");
        div.classList.add("question");
        let optionsHtml = q.options.map((opt, i) => `
          <label>
            <input type="radio" name="q${index}" value="${i}" onclick="checkMCQAnswer(this, ${q.correctIndex}, ${index})">
            ${opt}
          </label><br>
        `).join('');
        div.innerHTML = `
          <p><b>Q${index + 1}:</b> ${q.question}</p>
          ${optionsHtml}
        `;
        quizContainer.appendChild(div);
      });

      if (totalQuestions > 0) {
        let finishBtn = document.createElement("button");
        finishBtn.textContent = "Finish Quiz";
        finishBtn.onclick = showScore;
        quizContainer.appendChild(finishBtn);
      }
    }

    // Simple local question generator (MCQ or True/False) with difficulty adjustment
    function generateSimpleQuestions(lesson, num, difficulty, quizType) {
      let sentences = lesson.match(/[^.!?]+[.!?]/g) || [lesson];
      sentences = sentences.slice(0, num);
      let qs = [];
      let numOptions = quizType === 'true-false' ? 2 : (difficulty === 'easy' ? 3 : (difficulty === 'medium' ? 4 : 5));
      sentences.forEach(sentence => {
        let words = sentence.split(" ").filter(w => w.length > 3); // Filter short words
        if (words.length >= 1) {
          let correctIndex = Math.floor(Math.random() * numOptions); // Random correct position
          let question = quizType === 'true-false' ? `Is this statement true: "${sentence}"?` : "What is the best word to complete: " + sentence.replace(/\w+/g, (match, offset) => {
            return (offset % (difficulty === 'easy' ? 3 : 2) === 0) ? "____" : match; // More blanks for harder
          });
          let options = [];
          if (quizType === 'true-false') {
            options = ['True', 'False'];
            correctIndex = Math.random() < 0.5 ? 0 : 1; // Randomly true or false
          } else {
            for (let i = 0; i < numOptions; i++) {
              if (i === correctIndex) {
                options.push(words[Math.floor(Math.random() * words.length)]); // Correct (random from text)
              } else {
                options.push(generateDistractor(difficulty)); // Distractors based on difficulty
              }
            }
          }
          qs.push({ question, options, correctIndex });
        }
      });
      return qs;
    }

    // Helper for simple distractors (random words, harder = more obscure)
    function generateDistractor(difficulty) {
      const easyDistractors = ['apple', 'blue', 'house', 'quick', 'jump'];
      const mediumDistractors = ['river', 'mountain', 'happy', 'book', 'computer'];
      const hardDistractors = ['quantum', 'algorithm', 'paradox', 'synthesis', 'entropy'];
      const pool = difficulty === 'easy' ? easyDistractors : (difficulty === 'medium' ? mediumDistractors : hardDistractors);
      return pool[Math.floor(Math.random() * pool.length)];
    }

    // Gemini API integration for AI-generated questions with structured output
    async function generateAIQuestions(lesson, apiKey, num, difficulty, quizType) {
      const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + apiKey;
      const typeText = quizType === 'true-false' ? 'true/false questions with True and False options' : 'multiple-choice questions with 4 options and one best answer';
      const prompt = `Generate ${num} ${typeText} at ${difficulty} difficulty from the following text.

Text: ${lesson}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            responseMimeType: 'application/json',
            responseSchema: {
              type: 'ARRAY',
              items: {
                type: 'OBJECT',
                properties: {
                  question: { type: 'STRING' },
                  options: {
                    type: 'ARRAY',
                    items: { type: 'STRING' }
                  },
                  correctIndex: { type: 'INTEGER' }
                },
                propertyOrdering: ['question', 'options', 'correctIndex']
              }
            }
          }
        })
      });

      if (!response.ok) {
        throw new Error('API request failed: ' + response.statusText);
      }

      const data = await response.json();
      const jsonText = data.candidates[0].content.parts[0].text;
      return JSON.parse(jsonText);
    }

    function checkMCQAnswer(radio, correctIndex, qIndex) {
      const optionsContainer = radio.parentElement.parentElement; // Assuming label > input, parent is label, grandparent is options div
      const radios = document.querySelectorAll(`input[name="q${qIndex}"]`);
      let selectedValue = parseInt(radio.value);
      radios.forEach(r => r.disabled = true);
      if (selectedValue === correctIndex) {
        correctAnswers++;
        optionsContainer.style.color = "green";
      } else {
        optionsContainer.style.color = "red";
      }
    }

    function showScore() {
      const scoreText = `🎯 Your Score: ${correctAnswers} / ${totalQuestions}`;
      const scoreContainer = document.getElementById("scoreContainer");
      scoreContainer.innerHTML = scoreText;
      scoreContainer.style.display = 'inline-block'; // Show inline with title
      alert(scoreText); // Pop-up alert
    }

    function resetApp() {
      document.getElementById("lessonInput").value = "";
      document.getElementById("fileInput").value = "";
      document.getElementById("quizContainer").innerHTML = "";
      document.getElementById("scoreContainer").innerHTML = "";
      document.getElementById("scoreContainer").style.display = 'none';
      document.getElementById("errorContainer").innerHTML = "";
      totalQuestions = 0;
      correctAnswers = 0;
      questions = [];
      // Show input section and generate button again
      document.getElementById("inputSection").classList.remove("hidden");
      document.getElementById("generateButton").style.display = 'block';
    }
  </script>

</body>
</html>
