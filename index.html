<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Auto Quiz Generator</title>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      margin: 20px; 
      background: #f9f9f9; 
      line-height: 1.5; 
    }
    h2 { text-align: center; }
    textarea { 
      width: 100%; 
      height: 120px; 
      padding: 10px; 
      margin-bottom: 10px; 
      box-sizing: border-box; 
    }
    input[type="text"], input[type="file"], input[type="password"] { 
      width: 100%; 
      padding: 10px; 
      margin-bottom: 10px; 
      box-sizing: border-box; 
    }
    select { 
      width: 100%; 
      padding: 10px; 
      margin-bottom: 10px; 
      box-sizing: border-box; 
    }
    button { 
      padding: 10px 15px; 
      border: none; 
      background: #4CAF50; 
      color: white; 
      cursor: pointer; 
      border-radius: 6px; 
      margin-top: 10px; 
      width: 100%; 
      box-sizing: border-box; 
    }
    button:hover { background: #45a049; }
    .quiz { 
      margin-top: 20px; 
      padding: 15px; 
      background: white; 
      border-radius: 8px; 
      box-shadow: 0 2px 6px rgba(0,0,0,0.1); 
    }
    .question { margin-bottom: 15px; }
    .score { margin-top: 20px; font-weight: bold; font-size: 18px; text-align: center; }
    .api-section { margin-bottom: 20px; }
    .error { color: red; text-align: center; }
    .hidden { display: none; }

    /* Mobile responsiveness */
    @media (max-width: 600px) {
      body { margin: 10px; }
      h2 { font-size: 1.5em; }
      button { font-size: 1em; }
      .quiz { padding: 10px; }
    }
  </style>
  <!-- Include pdf.js for PDF support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.338/pdf.min.js"></script>
  <!-- Include mammoth.js for DOCX support -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.2/mammoth.browser.min.js"></script>
</head>
<body>

  <h2>ðŸ“˜ Auto Quiz Generator</h2>
  <p>Paste your lesson text or upload a file (TXT, PDF, DOCX):</p>

  <textarea id="lessonInput" placeholder="Paste your lesson here..."></textarea>
  
  <input type="file" id="fileInput" accept=".txt,.pdf,.docx">

  <div class="api-section">
    <p>Enter your Google Gemini API Key (optional for AI-generated quizzes):</p>
    <input type="password" id="apiKeyInput" placeholder="Your Gemini API Key">
  </div>

  <p>Select number of questions:</p>
  <select id="numQuestions">
    <option value="5">5</option>
    <option value="10">10</option>
    <option value="25">25</option>
    <option value="50">50</option>
  </select>

  <button onclick="generateQuiz()">Generate Quiz</button>

  <div id="quizContainer" class="quiz"></div>
  <div id="scoreContainer" class="score"></div>
  <div id="errorContainer" class="error"></div>

  <script>
    let totalQuestions = 0;
    let correctAnswers = 0;
    let questions = []; // To store generated questions

    // Handle file upload and extract text
    document.getElementById("fileInput").addEventListener("change", async function(event) {
      const file = event.target.files[0];
      if (!file) return;

      const lessonInput = document.getElementById("lessonInput");
      const errorContainer = document.getElementById("errorContainer");

      if (file.name.endsWith(".txt")) {
        const reader = new FileReader();
        reader.onload = function(e) {
          lessonInput.value = e.target.result;
        };
        reader.readAsText(file);
      } else if (file.name.endsWith(".docx")) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const arrayBuffer = e.target.result;
          const result = await mammoth.extractRawText({ arrayBuffer });
          lessonInput.value = result.value;
        };
        reader.readAsArrayBuffer(file);
      } else if (file.name.endsWith(".pdf")) {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const typedarray = new Uint8Array(e.target.result);
          const loadingTask = pdfjsLib.getDocument(typedarray);
          const pdf = await loadingTask.promise;
          let text = '';
          for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
            const page = await pdf.getPage(pageNum);
            const content = await page.getTextContent();
            text += content.items.map(item => item.str.trim()).filter(str => str).join(' ') + '\n\n';
          }
          lessonInput.value = text.trim(); // Clean up extra spaces
        };
        reader.readAsArrayBuffer(file);
      } else {
        errorContainer.innerHTML = "Unsupported file type. Please upload TXT, DOCX, or PDF.";
      }
    });

    async function generateQuiz() {
      const lesson = document.getElementById("lessonInput").value.trim();
      const apiKey = document.getElementById("apiKeyInput").value.trim();
      const numQuestions = document.getElementById("numQuestions").value;
      const quizContainer = document.getElementById("quizContainer");
      const scoreContainer = document.getElementById("scoreContainer");
      const errorContainer = document.getElementById("errorContainer");
      const apiSection = document.querySelector(".api-section");
      quizContainer.innerHTML = "";
      scoreContainer.innerHTML = "";
      errorContainer.innerHTML = "";
      totalQuestions = 0;
      correctAnswers = 0;
      questions = [];

      if (!lesson) {
        errorContainer.innerHTML = "Please paste text or upload a file first.";
        return;
      }

      // Hide API section after generation starts
      apiSection.classList.add("hidden");

      // If API key is provided, use Gemini API for advanced quiz generation
      if (apiKey) {
        try {
          const generatedQuestions = await generateAIQuestions(lesson, apiKey, numQuestions);
          questions = generatedQuestions;
        } catch (error) {
          errorContainer.innerHTML = "Error generating quiz with AI: " + error.message;
          apiSection.classList.remove("hidden"); // Show again on error
          return;
        }
      } else {
        // Fallback to simple fill-in-the-blank if no API key
        questions = generateSimpleQuestions(lesson, numQuestions);
      }

      if (questions.length === 0) {
        errorContainer.innerHTML = "Could not generate questions from the provided text.";
        apiSection.classList.remove("hidden"); // Show again on error
        return;
      }

      questions.forEach((q, index) => {
        totalQuestions++;
        let div = document.createElement("div");
        div.classList.add("question");
        if (q.type === 'fill-in-the-blank') {
          div.innerHTML = `
            <p><b>Q${index + 1}:</b> ${q.question}</p>
            <input type="text" placeholder="Your answer">
            <button onclick="checkAnswer(this, '${q.answer}')">Check</button>
          `;
        } else if (q.type === 'multiple-choice') {
          let optionsHtml = q.options.map((opt, i) => `
            <label>
              <input type="radio" name="q${index}" value="${i}">
              ${opt}
            </label><br>
          `).join('');
          div.innerHTML = `
            <p><b>Q${index + 1}:</b> ${q.question}</p>
            ${optionsHtml}
            <button onclick="checkMCQAnswer(this, ${q.correctIndex}, ${index})">Check</button>
          `;
        }
        quizContainer.appendChild(div);
      });

      if (totalQuestions > 0) {
        let finishBtn = document.createElement("button");
        finishBtn.textContent = "Finish Quiz";
        finishBtn.onclick = showScore;
        quizContainer.appendChild(finishBtn);
      }
    }

    // Simple fallback question generator
    function generateSimpleQuestions(lesson, num) {
      let sentences = lesson.match(/[^.!?]+[.!?]/g) || [lesson];
      sentences = sentences.slice(0, num);
      let qs = [];
      sentences.forEach(sentence => {
        let words = sentence.split(" ");
        if (words.length > 4) {
          let randomIndex = Math.floor(Math.random() * words.length);
          while (words[randomIndex].length < 4) {
            randomIndex = Math.floor(Math.random() * words.length);
          }
          let answer = words[randomIndex].replace(/[^a-zA-Z]/g, "");
          words[randomIndex] = "____";
          qs.push({ type: 'fill-in-the-blank', question: words.join(" "), answer });
        }
      });
      return qs;
    }

    // Gemini API integration for AI-generated questions with structured output
    async function generateAIQuestions(lesson, apiKey, num) {
      const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=' + apiKey;
      const prompt = `Generate ${num} quiz questions from the following text. Include a mix of fill-in-the-blank and multiple-choice questions.

Text: ${lesson}`;

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            responseMimeType: 'application/json',
            responseSchema: {
              type: 'ARRAY',
              items: {
                type: 'OBJECT',
                properties: {
                  type: { type: 'STRING' },
                  question: { type: 'STRING' },
                  answer: { type: 'STRING' },
                  options: {
                    type: 'ARRAY',
                    items: { type: 'STRING' }
                  },
                  correctIndex: { type: 'INTEGER' }
                },
                propertyOrdering: ['type', 'question', 'answer', 'options', 'correctIndex']
              }
            }
          }
        })
      });

      if (!response.ok) {
        throw new Error('API request failed: ' + response.statusText);
      }

      const data = await response.json();
      const jsonText = data.candidates[0].content.parts[0].text;
      return JSON.parse(jsonText);
    }

    function checkAnswer(button, correctAnswer) {
      const input = button.previousElementSibling;
      if (!input.disabled) {
        if (input.value.trim().toLowerCase() === correctAnswer.toLowerCase()) {
          correctAnswers++;
          input.style.borderColor = "green";
        } else {
          input.style.borderColor = "red";
        }
        input.disabled = true;
        button.disabled = true;
      }
    }

    function checkMCQAnswer(button, correctIndex, qIndex) {
      const radios = document.querySelectorAll(`input[name="q${qIndex}"]`);
      let selectedValue = -1;
      radios.forEach((radio, i) => {
        if (radio.checked) selectedValue = i;
        radio.disabled = true;
      });
      button.disabled = true;

      if (selectedValue === correctIndex) {
        correctAnswers++;
        button.previousElementSibling.style.color = "green"; // Highlight the options container
      } else {
        button.previousElementSibling.style.color = "red";
      }
    }

    function showScore() {
      const scoreContainer = document.getElementById("scoreContainer");
      scoreContainer.innerHTML = `ðŸŽ¯ Your Score: ${correctAnswers} / ${totalQuestions}`;
    }
  </script>

</body>
</html>
